<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Email Reader</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    h1 {
      font-size: 2.5em;
      font-weight: 300;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
      line-height: 1.6;
    }

    .content {
      padding: 40px;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 0.95em;
    }

    .input-field {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }

    .input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-field::placeholder {
      color: #999;
    }

    .optional {
      color: #999;
      font-size: 0.85em;
      font-weight: normal;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      text-decoration: none;
      display: inline-block;
      min-width: 200px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
    }

    .btn-test {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-test:hover {
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }

    .btn-success:hover {
      box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .data-section {
      margin-top: 30px;
    }

    .files-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .file-card {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-card:hover {
      border-color: #667eea;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .file-card.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      word-break: break-all;
    }

    .file-info {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 15px;
    }

    .file-size {
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      color: #495057;
      display: inline-block;
    }

    .data-display {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-top: 30px;
      max-height: 600px;
      overflow-y: auto;
    }

    .email-item {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .email-subject {
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
    }

    .email-date {
      font-size: 0.9em;
      color: #666;
    }

    .email-from {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .email-snippet {
      color: #666;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .email-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      font-size: 0.9em;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-label {
      font-weight: 500;
      color: #333;
    }

    .detail-value {
      color: #666;
    }

    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .keyword {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
      }

      .header {
        padding: 30px 20px;
      }

      .content {
        padding: 20px;
      }

      h1 {
        font-size: 2em;
      }

      .files-list {
        grid-template-columns: 1fr;
      }

      .btn {
        min-width: 150px;
        padding: 12px 20px;
        font-size: 1em;
      }
    }

    .card-preview {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }

    .masked {
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Personal Finance Email Reader</h1>
      <p class="subtitle">Securely read your bank statements and store them locally</p>
    </div>
    
    <div class="content">
      <div class="form-section">
        <h2>Account Information</h2>
        <form id="accountForm">
          <div class="form-group">
            <label for="bankAccount">Bank Account Number <span class="optional">(optional)</span></label>
            <input 
              type="text" 
              id="bankAccount" 
              name="bankAccount" 
              class="input-field" 
              placeholder="Enter your bank account number"
              maxlength="20"
              pattern="[0-9]*"
            >
          </div>

          <div class="form-group">
            <label for="creditCard">Credit Card Number <span class="optional">(optional)</span></label>
            <input 
              type="text" 
              id="creditCard" 
              name="creditCard" 
              class="input-field" 
              placeholder="Enter your credit card number"
              maxlength="19"
              pattern="[0-9\s]*"
            >
            <div class="card-preview" id="cardPreview"></div>
          </div>
        </form>

        <div class="button-group">
          <button class="btn" onclick="authenticate()">Subscribe with Google</button>
          <button class="btn btn-secondary" onclick="fetchEmails()">Fetch Emails</button>
          <button class="btn btn-success" onclick="loadStoredData()">Load Stored Data</button>
          <button class="btn btn-test" onclick="testAPI()">Test Hello API</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>
      </div>

      <div class="data-section" id="dataSection" style="display: none;">
        <h2>Stored Data Files</h2>
        <div id="filesList" class="files-list"></div>
        
        <div id="dataDisplay" class="data-display" style="display: none;">
          <h3 id="selectedFileName"></h3>
          <div id="emailsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Credit card formatting and preview
    const creditCardInput = document.getElementById('creditCard');
    const cardPreview = document.getElementById('cardPreview');

    creditCardInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
      
      // Format with spaces
      if (value.length > 0) {
        value = value.match(/.{1,4}/g).join(' ');
      }
      
      e.target.value = value;
      
      // Show preview
      if (value.length > 0) {
        const masked = value.replace(/\d(?=\d{4})/g, '*');
        cardPreview.textContent = `Preview: ${masked}`;
      } else {
        cardPreview.textContent = '';
      }
    });

    // Bank account number formatting
    const bankAccountInput = document.getElementById('bankAccount');
    
    bankAccountInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      e.target.value = value;
    });

    // Form data collection
    function getFormData() {
      const formData = new FormData(document.getElementById('accountForm'));
      const data = {};
      for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
          data[key] = value;
        }
      }
      return data;
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Authentication function
    function authenticate() {
      const formData = getFormData();
      showStatus('Redirecting to Google authentication...', 'info');
      
      // Store form data in sessionStorage for later use
      sessionStorage.setItem('accountData', JSON.stringify(formData));
      
      // Redirect to auth endpoint
      window.location.href = '/api/auth';
    }

    // Fetch emails function
    function fetchEmails() {
      const formData = getFormData();
      showStatus('Fetching emails...', 'info');
      
      fetch('/api/fetch-emails', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus(`Emails fetched and saved to ${data.filename}!`, 'success');
          // Automatically load stored data after fetching
          setTimeout(() => loadStoredData(), 1000);
        } else {
          showStatus(data.error || 'Failed to fetch emails', 'error');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error');
      });
    }

    // Load stored data function
    function loadStoredData() {
      showStatus('Loading stored data...', 'info');
      
      fetch('/api/stored-data')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayFilesList(data.files);
            showStatus(`Loaded ${data.files.length} stored files`, 'success');
          } else {
            showStatus(data.error || 'Failed to load stored data', 'error');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error');
        });
    }

    // Display files list
    function displayFilesList(files) {
      const filesListDiv = document.getElementById('filesList');
      const dataSection = document.getElementById('dataSection');
      
      if (files.length === 0) {
        filesListDiv.innerHTML = '<div class="no-data">No stored data files found. Fetch some emails first!</div>';
      } else {
        filesListDiv.innerHTML = files.map(file => `
          <div class="file-card" onclick="loadFileContent('${file.filename}')">
            <div class="file-name">${file.filename}</div>
            <div class="file-info">
              <div>Created: ${new Date(file.created).toLocaleString()}</div>
              <div>Modified: ${new Date(file.modified).toLocaleString()}</div>
            </div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
        `).join('');
      }
      
      dataSection.style.display = 'block';
    }

    // Load file content
    function loadFileContent(filename) {
      showStatus(`Loading ${filename}...`, 'info');
      
      fetch(`/api/stored-data/${filename}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayEmailData(filename, data.data);
            showStatus(`Loaded ${filename}`, 'success');
          } else {
            showStatus(data.error || 'Failed to load file content', 'error');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error');
        });
    }

    // Display email data
    function displayEmailData(filename, data) {
      const selectedFileName = document.getElementById('selectedFileName');
      const emailsList = document.getElementById('emailsList');
      const dataDisplay = document.getElementById('dataDisplay');
      
      selectedFileName.textContent = filename;
      
      if (data.emails && data.emails.length > 0) {
        emailsList.innerHTML = data.emails.map(email => `
          <div class="email-item">
            <div class="email-header">
              <div class="email-subject">${email.subject || 'No Subject'}</div>
              <div class="email-date">${formatDate(email.date)}</div>
            </div>
            <div class="email-from">From: ${email.from_mail || 'Unknown'}</div>
            <div class="email-snippet">${email.snippet || 'No content'}</div>
            <div class="email-details">
              <div class="detail-row">
                <span class="detail-label">Email ID:</span>
                <span class="detail-value">${email.email_id}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Bank Account:</span>
                <span class="detail-value">${email.account_details.bankAccount || 'Not provided'}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Credit Card:</span>
                <span class="detail-value">${email.account_details.creditCard ? '****' + email.account_details.creditCard.slice(-4) : 'Not provided'}</span>
              </div>
              ${email.bank_details ? `
                <div class="detail-row">
                  <span class="detail-label">Detected Keywords:</span>
                  <span class="detail-value">
                    <div class="keywords">
                      ${email.bank_details.detected_keywords.map(keyword => `<span class="keyword">${keyword}</span>`).join('')}
                    </div>
                  </span>
                </div>
              ` : ''}
              <div class="detail-row">
                <span class="detail-label">Processed:</span>
                <span class="detail-value">${formatDate(email.processed_at)}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        emailsList.innerHTML = '<div class="no-data">No emails found in this file</div>';
      }
      
      dataDisplay.style.display = 'block';
    }

    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return 'Unknown';
      try {
        return new Date(dateString).toLocaleString();
      } catch {
        return dateString;
      }
    }

    // Test API function
    function testAPI() {
      showStatus('Testing API connection...', 'info');
      
      fetch('/api/hello')
        .then(response => response.json())
        .then(data => {
          showStatus('API Test: ' + data.message, 'success');
        })
        .catch(error => {
          showStatus('API Test failed: ' + error.message, 'error');
        });
    }

    // Load stored form data on page load
    window.addEventListener('load', function() {
      const storedData = sessionStorage.getItem('accountData');
      if (storedData) {
        const data = JSON.parse(storedData);
        if (data.bankAccount) {
          document.getElementById('bankAccount').value = data.bankAccount;
        }
        if (data.creditCard) {
          document.getElementById('creditCard').value = data.creditCard;
        }
      }
    });
  </script>
</body>
</html> 