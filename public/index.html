<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Email Reader</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    h1 {
      font-size: 2.5em;
      font-weight: 300;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
      line-height: 1.6;
    }

    .content {
      padding: 40px;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 0.95em;
    }

    .input-field {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }

    .input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-field::placeholder {
      color: #999;
    }

    .optional {
      color: #999;
      font-size: 0.85em;
      font-weight: normal;
    }

    .required {
      color: #e74c3c;
      font-size: 0.85em;
      font-weight: normal;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      text-decoration: none;
      display: inline-block;
      min-width: 200px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
    }

    .btn-test {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-test:hover {
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }

    .btn-success:hover {
      box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-warning:hover {
      box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .data-section {
      margin-top: 30px;
    }

    .files-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .file-card {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-card:hover {
      border-color: #667eea;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .file-card.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      word-break: break-all;
    }

    .file-info {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 15px;
    }

    .file-size {
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      color: #495057;
      display: inline-block;
    }

    .data-display {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-top: 30px;
      max-height: 600px;
      overflow-y: auto;
    }

    .email-item {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .email-subject {
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
    }

    .email-date {
      font-size: 0.9em;
      color: #666;
    }

    .email-from {
      color: #667eea;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .email-snippet {
      color: #666;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .email-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      font-size: 0.9em;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-label {
      font-weight: 500;
      color: #333;
    }

    .detail-value {
      color: #666;
    }

    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .keyword {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
    }

    .transaction-details {
      background: #e8f5e8;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .transaction-type {
      font-weight: 600;
      margin-bottom: 10px;
    }

    .transaction-type.debit {
      color: #e74c3c;
    }

    .transaction-type.credit {
      color: #27ae60;
    }

    .amount {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .merchant {
      color: #666;
      font-style: italic;
    }

    .statement-details {
      background: #fff3cd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .password-hint {
      background: #d1ecf1;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #0c5460;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    .tab-container {
      margin-bottom: 30px;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 2px solid #e1e5e9;
      margin-bottom: 20px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 15px 30px;
      font-size: 1em;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    /* Sub-tab styles */
    .sub-tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .sub-tab-button {
      padding: 10px 20px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      color: #333;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .sub-tab-button:hover {
      background: #e9ecef;
    }

    .sub-tab-button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .sub-tab-content {
      display: block;
    }

    .sub-tab-content.hidden {
      display: none;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .account-list {
      margin-top: 15px;
    }

    .account-item {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .account-name {
      font-weight: 600;
      color: #333;
    }

    .account-number {
      color: #666;
      font-family: monospace;
    }

    .remove-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      cursor: pointer;
    }

    .add-account-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
      }

      .header {
        padding: 30px 20px;
      }

      .content {
        padding: 20px;
      }

      h1 {
        font-size: 2em;
      }

      .files-list {
        grid-template-columns: 1fr;
      }

      .btn {
        min-width: 150px;
        padding: 12px 20px;
        font-size: 1em;
      }

      .tab-buttons {
        flex-direction: column;
      }

      .tab-button {
        border-bottom: none;
        border-right: 3px solid transparent;
      }

      .tab-button.active {
        border-right-color: #667eea;
      }
    }

    .card-preview {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }

    .masked {
      color: #999;
    }

    /* Spinner styles */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn:disabled:hover {
      transform: none !important;
      box-shadow: none !important;
    }

    .loading-text {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Radio button styling */
    input[type="radio"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    input[type="radio"] + label {
      cursor: pointer;
      font-weight: 500;
    }

    .fetch-method-group {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
    <h1>Personal Finance Email Reader</h1>
      <p class="subtitle">Securely read your bank statements and track transactions</p>
    </div>
    
    <div class="content">
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="showTab('setup')">Profile Setup</button>
          <button class="tab-button" onclick="showTab('profiles')">Saved Profiles</button>
          <button class="tab-button" onclick="showTab('fetch')">Fetch & Process Data</button>
          <button class="tab-button" onclick="showTab('view')">View Transactions</button>
          <button class="tab-button" onclick="showTab('pdfs')">PDF Attachments</button>
        </div>
      </div>

      <!-- Profile Setup Tab -->
      <div id="setupTab" class="tab-content active">
        <div class="form-section">
          <h2>User Profile Setup</h2>
          <p>Set up your profile to map transactions to your accounts</p>
          
          <form id="userProfileForm">
            <div class="form-group">
              <label for="firstName">First Name <span class="required">*</span></label>
              <input type="text" id="firstName" name="firstName" class="input-field" placeholder="Enter your first name" required>
            </div>

            <div class="form-group">
              <label for="lastName">Last Name <span class="required">*</span></label>
              <input type="text" id="lastName" name="lastName" class="input-field" placeholder="Enter your last name" required>
            </div>

            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input type="email" id="email" name="email" class="input-field" placeholder="Enter your email address" required>
            </div>

            <h3>Bank Accounts</h3>
            <div id="bankAccountsList" class="account-list"></div>
            <button type="button" class="add-account-btn" onclick="addBankAccount()">+ Add Bank Account</button>

            <h3>Credit Cards</h3>
            <div id="creditCardsList" class="account-list"></div>
            <button type="button" class="add-account-btn" onclick="addCreditCard()">+ Add Credit Card</button>

            <h3>Identifiers (for Statement Passwords)</h3>
            <div class="form-group">
              <label for="panNumber">PAN Number <span class="optional">(optional)</span></label>
              <input type="text" id="panNumber" name="panNumber" class="input-field" placeholder="Enter your PAN number" maxlength="10">
            </div>

            <div class="form-group">
              <label for="dateOfBirth">Date of Birth <span class="optional">(optional)</span></label>
              <input type="date" id="dateOfBirth" name="dateOfBirth" class="input-field">
      </div>

      <div class="form-group">
              <label for="phoneNumber">Phone Number <span class="optional">(optional)</span></label>
              <input type="tel" id="phoneNumber" name="phoneNumber" class="input-field" placeholder="Enter your phone number">
      </div>
    </form>

    <div class="button-group">
      <button class="btn" onclick="authenticate()">Subscribe with Google</button>
            <button class="btn btn-success" onclick="setupUserProfile()">Save Profile</button>
      <button class="btn btn-test" onclick="testAPI()">Test Hello API</button>
    </div>

    <div id="status" class="status" style="display: none;"></div>
        </div>
      </div>

      <!-- Saved Profiles Tab -->
      <div id="profilesTab" class="tab-content">
        <div class="form-section">
          <h2>Saved Profiles</h2>
          <p>Manage your saved profiles and continue with existing sessions</p>
          
          <div class="button-group">
            <button class="btn btn-secondary" id="loadProfilesBtn" onclick="loadSavedProfiles()">
              <span class="btn-text">Load Saved Profiles</span>
              <span class="spinner" style="display: none;"></span>
            </button>
          </div>

          <div id="profilesList" class="files-list" style="display: none;"></div>
          
          <div id="profileDetails" class="data-display" style="display: none;">
            <h3 id="selectedProfileName"></h3>
            <div id="profileInfo"></div>
            <div class="button-group" style="margin-top: 20px;">
              <button class="btn btn-success" onclick="continueWithProfile()">Continue with this Profile</button>
              <button class="btn btn-secondary" onclick="editProfile()">Edit Profile</button>
              <button class="btn btn-warning" onclick="deleteProfile()">Delete Profile</button>
            </div>
          </div>

          <div id="profilesStatus" class="status" style="display: none;"></div>
        </div>
      </div>

      <!-- Fetch & Process Data Tab -->
      <div id="fetchTab" class="tab-content">
        <div class="form-section">
          <h2>Fetch & Process Financial Data</h2>
          <p>Fetch emails and automatically process them with Gemini AI for structured transaction data</p>
          
          <div id="fetchPrerequisites" class="status info" style="display: none;">
            <strong>Before fetching data:</strong>
            <ol style="margin-top: 10px; margin-left: 20px;">
              <li>Set up your profile in the "Profile Setup" tab</li>
              <li>Click "Subscribe with Google" to authenticate</li>
              <li>Save your profile</li>
            </ol>
          </div>
          
          <div class="form-group">
            <label for="queryType">Data Type</label>
            <select id="queryType" class="input-field">
              <option value="all">All Financial Data</option>
              <option value="bank">Bank Transactions Only</option>
              <option value="credit">Credit Card Transactions Only</option>
              <option value="statements">Statements Only</option>
            </select>
          </div>

          <div class="form-group">
            <label for="emailType">Email Type</label>
            <select id="emailType" class="input-field">
              <option value="both">Both Transaction Alerts & Statements</option>
              <option value="transaction_alerts">Transaction Alerts Only</option>
              <option value="periodic_statements">Periodic Statements Only</option>
            </select>
          </div>

          <div class="form-group fetch-method-group">
            <label style="font-weight: 600; margin-bottom: 10px; display: block;">Fetch Method</label>
            <div style="margin-top: 10px;">
              <label style="display: inline-block; margin-right: 20px;">
                <input type="radio" name="fetchMethod" value="count" checked onchange="toggleFetchMethod()">
                By Number of Emails
              </label>
              <label style="display: inline-block;">
                <input type="radio" name="fetchMethod" value="date" onchange="toggleFetchMethod()">
                By Date Range
              </label>
            </div>
          </div>

          <div class="form-group" id="maxEmailsGroup">
            <label for="maxEmails">Maximum Number of Emails</label>
            <input type="number" id="maxEmails" class="input-field" placeholder="30" min="1" max="100" value="30">
            <small style="color: #666; font-size: 0.9em;">Batched processing allows up to 100 emails efficiently (10 emails per API call)</small>
          </div>

          <div class="form-group" id="dateRangeGroup" style="display: none;">
            <label for="fromDate">From Date</label>
            <input type="date" id="fromDate" class="input-field">
          </div>

          <div class="form-group" id="toDateGroup" style="display: none;">
            <label for="toDate">To Date</label>
            <input type="date" id="toDate" class="input-field">
          </div>

          <div class="button-group">
            <button class="btn btn-success" id="fetchAndProcessBtn" onclick="fetchAndProcessData()">
              <span class="btn-text">Fetch & Process with Gemini AI</span>
              <span class="spinner" style="display: none;"></span>
            </button>
            <button class="btn btn-warning" id="fetchLegacyBtn" onclick="fetchLegacyEmails()">
              <span class="btn-text">Fetch Legacy Emails (No AI)</span>
              <span class="spinner" style="display: none;"></span>
            </button>
          </div>
          
          <div class="button-group" style="margin-top: 20px; border-top: 1px solid #e1e5e9; padding-top: 20px;">
            <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="deleteAllData()">
              <span class="btn-text">üóëÔ∏è Delete All Data</span>
            </button>
          </div>

          <div id="fetchStatus" class="status" style="display: none;"></div>
        </div>
      </div>

      <!-- View Transactions Tab -->
      <div id="viewTab" class="tab-content">
        <div class="form-section">
          <h2>View Data</h2>
          <p>View and analyze your email data and processed transactions</p>
          
          <!-- Sub-tabs for different data types -->
          <div class="sub-tab-buttons" style="margin-bottom: 20px;">
            <button class="sub-tab-button active" onclick="showSubTab('pureData')">Pure Data (Raw Emails)</button>
            <button class="sub-tab-button" onclick="showSubTab('geminiData')">Gemini Processed Data</button>
          </div>

          <!-- Pure Data Sub-tab -->
          <div id="pureDataSubTab" class="sub-tab-content">
            <h3>Raw Email Data</h3>
            <p>View original email data from the data folder</p>
            
            <div class="form-group">
              <label for="pureDataFromDate">From Date (Optional)</label>
              <input type="date" id="pureDataFromDate" class="input-field">
            </div>

            <div class="form-group">
              <label for="pureDataToDate">To Date (Optional)</label>
              <input type="date" id="pureDataToDate" class="input-field">
            </div>
          
          <div class="button-group">
              <button class="btn btn-secondary" id="loadPureDataBtn" onclick="loadPureData()">
                <span class="btn-text">Load Raw Email Data</span>
              <span class="spinner" style="display: none;"></span>
            </button>
          </div>

            <div id="pureDataSection" class="data-section" style="display: none;">
              <div id="pureDataFilesList" class="files-list"></div>
              
              <div id="pureDataDisplay" class="data-display" style="display: none;">
                <h3 id="selectedPureDataFileName"></h3>
                <div id="pureDataList"></div>
          </div>
        </div>
      </div>

          <!-- Gemini Processed Data Sub-tab -->
          <div id="geminiDataSubTab" class="sub-tab-content hidden">
            <h3>Gemini AI Processed Transactions</h3>
            <p>View structured transaction data processed by Gemini AI</p>
          
          <div class="form-group">
              <label for="geminiDataFromDate">From Date (Optional)</label>
              <input type="date" id="geminiDataFromDate" class="input-field">
          </div>

          <div class="form-group">
              <label for="geminiDataToDate">To Date (Optional)</label>
              <input type="date" id="geminiDataToDate" class="input-field">
          </div>

          <div class="button-group">
              <button class="btn btn-success" id="loadGeminiDataBtn" onclick="loadGeminiData()">
                <span class="btn-text">Load Gemini Processed Data</span>
              <span class="spinner" style="display: none;"></span>
            </button>
          </div>

            <div id="geminiDataSection" class="data-section" style="display: none;">
              <div id="geminiDataFilesList" class="files-list"></div>
              
              <div id="geminiDataDisplay" class="data-display" style="display: none;">
                <h3 id="selectedGeminiDataFileName"></h3>
                <div id="geminiDataList"></div>
            </div>
          </div>
          </div>
        </div>
      </div>



      <!-- PDF Attachments Tab -->
      <div id="pdfsTab" class="tab-content">
        <div class="form-section">
          <h2>PDF Attachments</h2>
          <p>View and download PDF statements and attachments from your emails</p>
          
          <div class="button-group">
            <button class="btn btn-success" id="loadPDFsBtn" onclick="loadPDFAttachments()">
              <span class="btn-text">Load PDF Attachments</span>
              <span class="spinner" style="display: none;"></span>
            </button>
          </div>

          <div id="pdfsSection" class="data-section" style="display: none;">
            <div id="pdfsList" class="files-list"></div>
          </div>

          <div id="pdfsStatus" class="status" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUserId = null;
    let currentProfile = null;
    let bankAccounts = [];
    let creditCards = [];
    let selectedProfileId = null;

    // Tab functionality
    function showTab(tabName) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Remove active class from all tab buttons
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));
      
      // Show selected tab content
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Show/hide prerequisites for fetch tab
      if (tabName === 'fetch') {
        const prerequisitesDiv = document.getElementById('fetchPrerequisites');
        if (!currentUserId) {
          prerequisitesDiv.style.display = 'block';
        } else {
          prerequisitesDiv.style.display = 'none';
        }
      }
    }

    // Add bank account
    function addBankAccount() {
      const accountId = 'bank_' + Date.now();
      const accountHtml = `
        <div class="account-item" id="${accountId}">
          <div class="account-header">
            <div>
              <input type="text" placeholder="Bank Name" class="input-field" style="width: 150px; margin-right: 10px;" onchange="updateBankAccount('${accountId}', 'bankName', this.value)">
              <input type="text" placeholder="Account Number" class="input-field" style="width: 200px; margin-right: 10px;" onchange="updateBankAccount('${accountId}', 'accountNumber', this.value)">
              <select class="input-field" style="width: 120px;" onchange="updateBankAccount('${accountId}', 'accountType', this.value)">
                <option value="savings">Savings</option>
                <option value="current">Current</option>
                <option value="salary">Salary</option>
              </select>
            </div>
            <button class="remove-btn" onclick="removeAccount('${accountId}', 'bank')">Remove</button>
          </div>
        </div>
      `;
      document.getElementById('bankAccountsList').insertAdjacentHTML('beforeend', accountHtml);
    }

    // Add credit card
    function addCreditCard() {
      const cardId = 'card_' + Date.now();
      const cardHtml = `
        <div class="account-item" id="${cardId}">
          <div class="account-header">
            <div>
              <input type="text" placeholder="Card Provider" class="input-field" style="width: 150px; margin-right: 10px;" onchange="updateCreditCard('${cardId}', 'provider', this.value)">
              <input type="text" placeholder="Card Number" class="input-field" style="width: 200px; margin-right: 10px;" onchange="updateCreditCard('${cardId}', 'cardNumber', this.value)">
              <select class="input-field" style="width: 120px;" onchange="updateCreditCard('${cardId}', 'cardType', this.value)">
                <option value="visa">Visa</option>
                <option value="mastercard">Mastercard</option>
                <option value="amex">American Express</option>
                <option value="rupay">RuPay</option>
              </select>
            </div>
            <button class="remove-btn" onclick="removeAccount('${cardId}', 'credit')">Remove</button>
          </div>
        </div>
      `;
      document.getElementById('creditCardsList').insertAdjacentHTML('beforeend', cardHtml);
    }

    // Update bank account
    function updateBankAccount(accountId, field, value) {
      const account = bankAccounts.find(acc => acc.id === accountId) || { id: accountId };
      account[field] = value;
      
      if (!bankAccounts.find(acc => acc.id === accountId)) {
        bankAccounts.push(account);
      }
    }

    // Update credit card
    function updateCreditCard(cardId, field, value) {
      const card = creditCards.find(c => c.id === cardId) || { id: cardId };
      card[field] = value;
      
      if (!creditCards.find(c => c.id === cardId)) {
        creditCards.push(card);
      }
    }

    // Remove account
    function removeAccount(accountId, type) {
      document.getElementById(accountId).remove();
      
      if (type === 'bank') {
        bankAccounts = bankAccounts.filter(acc => acc.id !== accountId);
      } else {
        creditCards = creditCards.filter(card => card.id !== accountId);
      }
    }

    // Form data collection
    function getFormData() {
      const formData = new FormData(document.getElementById('userProfileForm'));
      const data = {};
      for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
          data[key] = value;
        }
      }
      return data;
    }

    // Show status message
    function showStatus(message, type = 'info', statusId = 'status') {
      const statusDiv = document.getElementById(statusId);
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Authentication function
    function authenticate() {
      showStatus('Redirecting to Google authentication...', 'info');
      window.location.href = '/api/auth';
    }

    // Setup user profile
    function setupUserProfile() {
      const formData = getFormData();
      
      if (!formData.firstName || !formData.lastName || !formData.email) {
        showStatus('Please fill in all required fields (First Name, Last Name, Email)', 'error');
        return;
      }

      const profileData = {
        ...formData,
        bankAccounts: bankAccounts.filter(acc => acc.bankName && acc.accountNumber),
        creditCards: creditCards.filter(card => card.provider && card.cardNumber),
        identifiers: {
          panNumber: formData.panNumber || null,
          dateOfBirth: formData.dateOfBirth || null,
          phoneNumber: formData.phoneNumber || null
        }
      };

      // Determine if this is a new profile or update
      const isUpdate = currentUserId !== null;
      const url = isUpdate ? `/api/user-profile/${currentUserId}` : '/api/setup-user';
      const method = isUpdate ? 'PUT' : 'POST';
      
      showStatus(isUpdate ? 'Updating user profile...' : 'Setting up user profile...', 'info');

      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(profileData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (!isUpdate) {
            currentUserId = data.userId;
          }
          showStatus(isUpdate ? 'Profile updated successfully!' : 'Profile saved successfully! You can now fetch transactions.', 'success');
          // Switch to fetch tab
          showTab('fetch');
          // Hide prerequisites message
          document.getElementById('fetchPrerequisites').style.display = 'none';
        } else {
          showStatus(data.error || (isUpdate ? 'Failed to update profile' : 'Failed to save profile'), 'error');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error');
      });
    }

    // Fetch transactions
    function fetchTransactions() {
      if (!currentUserId) {
        showStatus('Please set up your profile first', 'error', 'fetchStatus');
        return;
      }

      const queryType = document.getElementById('queryType').value;
      const btn = document.getElementById('fetchTransactionsBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = `Fetching ${queryType} transactions...`;
      spinner.style.display = 'inline-block';
      
      showStatus(`Fetching ${queryType} transactions...`, 'info', 'fetchStatus');

      fetch('/api/fetch-transactions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUserId,
          queryType: queryType
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus(`Successfully fetched ${data.data.emails.length} emails and saved to ${data.filename}`, 'success', 'fetchStatus');
          // Switch to view tab
          showTab('view');
          setTimeout(() => loadStoredData(), 1000);
        } else {
          showStatus(data.error || 'Failed to fetch transactions', 'error', 'fetchStatus');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error', 'fetchStatus');
      })
      .finally(() => {
        // Hide spinner and re-enable button
        btn.disabled = false;
        btnText.textContent = 'Fetch Transactions';
        spinner.style.display = 'none';
      });
    }

    // Fetch legacy emails (backward compatibility)
    function fetchLegacyEmails() {
      const btn = document.getElementById('fetchLegacyBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = 'Fetching legacy emails...';
      spinner.style.display = 'inline-block';
      
      showStatus('Fetching legacy emails...', 'info', 'fetchStatus');
      
      fetch('/api/fetch-emails', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus(`Successfully fetched ${data.data.emails.length} emails and saved to ${data.filename}`, 'success', 'fetchStatus');
          setTimeout(() => loadStoredData(), 1000);
        } else {
          showStatus(data.error || 'Failed to fetch emails', 'error', 'fetchStatus');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error', 'fetchStatus');
      })
      .finally(() => {
        // Hide spinner and re-enable button
        btn.disabled = false;
        btnText.textContent = 'Fetch Legacy Emails';
        spinner.style.display = 'none';
      });
    }

    // Show sub-tab function
    function showSubTab(subTabName) {
      console.log(`[DEBUG] showSubTab called with: ${subTabName}`);
      
      // Hide all sub-tab contents
      document.querySelectorAll('.sub-tab-content').forEach(content => {
        content.classList.add('hidden');
        console.log(`[DEBUG] Hiding sub-tab content: ${content.id}`);
      });
      
      // Remove active class from all sub-tab buttons
      document.querySelectorAll('.sub-tab-button').forEach(btn => {
        btn.classList.remove('active');
        console.log(`[DEBUG] Removing active class from button: ${btn.textContent}`);
      });
      
      // Show selected sub-tab content
      const selectedContent = document.getElementById(subTabName + 'SubTab');
      console.log(`[DEBUG] Looking for content with ID: ${subTabName}SubTab`);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
        console.log(`[DEBUG] Showing sub-tab content: ${selectedContent.id}`);
      } else {
        console.error(`[DEBUG] Could not find sub-tab content with ID: ${subTabName}SubTab`);
      }
      
      // Add active class to selected button
      const selectedButton = document.querySelector(`[onclick="showSubTab('${subTabName}')"]`);
      console.log(`[DEBUG] Looking for button with onclick="showSubTab('${subTabName}')"`);
      if (selectedButton) {
        selectedButton.classList.add('active');
        console.log(`[DEBUG] Added active class to button: ${selectedButton.textContent}`);
      } else {
        console.error(`[DEBUG] Could not find button with onclick="showSubTab('${subTabName}')"`);
      }
    }

    // Load pure data function (raw emails)
    function loadPureData() {
      const btn = document.getElementById('loadPureDataBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = 'Loading raw email data...';
      spinner.style.display = 'inline-block';
      
      showStatus('Loading raw email data...', 'info', 'fetchStatus');
      
      // Load raw email data from data folder
      fetch('/api/stored-data')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayPureDataFilesList(data.files);
            showStatus(`Loaded ${data.files.length} raw email files`, 'success', 'fetchStatus');
          } else {
            showStatus(data.error || 'Failed to load raw email data', 'error', 'fetchStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'fetchStatus');
        })
        .finally(() => {
          // Hide spinner and re-enable button
          btn.disabled = false;
          btnText.textContent = 'Load Raw Email Data';
          spinner.style.display = 'none';
        });
    }

    // Load Gemini processed data function
    function loadGeminiData() {
      const btn = document.getElementById('loadGeminiDataBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = 'Loading Gemini processed data...';
      spinner.style.display = 'inline-block';
      
      showStatus('Loading Gemini processed data...', 'info', 'fetchStatus');
      
      // Load Gemini processed transactions
      fetch('/api/transactions-hub')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Filter for Gemini processed files
            const geminiFiles = data.files
              .filter(file => file.filename.startsWith('gemini_transactions_'))
              .map(file => ({
                ...file,
                filename: file.filename.replace('gemini_transactions_', 'Transactions - ').replace('.json', '')
              }));
            
            displayGeminiDataFilesList(geminiFiles);
            showStatus(`Loaded ${geminiFiles.length} Gemini processed files`, 'success', 'fetchStatus');
          } else {
            showStatus(data.error || 'Failed to load Gemini data', 'error', 'fetchStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'fetchStatus');
        })
        .finally(() => {
          // Hide spinner and re-enable button
          btn.disabled = false;
          btnText.textContent = 'Load Gemini Processed Data';
          spinner.style.display = 'none';
        });
    }

    // Display pure data files list
    function displayPureDataFilesList(files) {
      const filesListDiv = document.getElementById('pureDataFilesList');
      const dataSection = document.getElementById('pureDataSection');
      
      if (files.length === 0) {
        filesListDiv.innerHTML = '<div class="no-data">No raw email files found</div>';
      } else {
        filesListDiv.innerHTML = files.map(file => `
          <div class="file-card" onclick="loadPureDataContent('${file.filename}')">
            <div class="file-name">${file.filename}</div>
            <div class="file-info">
              <div>Created: ${new Date(file.created).toLocaleString()}</div>
              <div>Modified: ${new Date(file.modified).toLocaleString()}</div>
            </div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
        `).join('');
      }
      
      dataSection.style.display = 'block';
    }

    // Display Gemini data files list
    function displayGeminiDataFilesList(files) {
      const filesListDiv = document.getElementById('geminiDataFilesList');
      const dataSection = document.getElementById('geminiDataSection');
      
      if (files.length === 0) {
        filesListDiv.innerHTML = '<div class="no-data">No Gemini processed files found</div>';
      } else {
        filesListDiv.innerHTML = files.map(file => `
          <div class="file-card" onclick="loadGeminiDataContent('${file.filename}')">
            <div class="file-name">${file.filename}</div>
            <div class="file-info">
              <div>Created: ${new Date(file.created).toLocaleString()}</div>
              <div>Modified: ${new Date(file.modified).toLocaleString()}</div>
            </div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
        `).join('');
      }
      
      dataSection.style.display = 'block';
    }

    // Display files list (legacy function for backward compatibility)
    function displayFilesList(files) {
      const filesListDiv = document.getElementById('filesList');
      const dataSection = document.getElementById('dataSection');
      
      if (files.length === 0) {
        filesListDiv.innerHTML = '<div class="no-data">No stored data files found. Fetch some data first!</div>';
      } else {
        filesListDiv.innerHTML = files.map(file => `
          <div class="file-card" onclick="loadFileContent('${file.filename}')">
            <div class="file-name">${file.filename}</div>
            <div class="file-info">
              <div>Created: ${new Date(file.created).toLocaleString()}</div>
              <div>Modified: ${new Date(file.modified).toLocaleString()}</div>
            </div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
        `).join('');
      }
      
      dataSection.style.display = 'block';
    }

    // Load pure data content (raw emails)
    function loadPureDataContent(filename) {
      showStatus(`Loading ${filename}...`, 'info', 'fetchStatus');
      
      fetch(`/api/stored-data/${filename}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayPureDataContent(filename, data.data);
            showStatus(`Loaded ${filename}`, 'success', 'fetchStatus');
          } else {
            showStatus(data.error || 'Failed to load file content', 'error', 'fetchStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'fetchStatus');
        });
    }

    // Load Gemini data content
    function loadGeminiDataContent(filename) {
      showStatus(`Loading ${filename}...`, 'info', 'fetchStatus');
      
      // Convert display filename back to actual filename
      // Display: "Transactions - both_2025-08-13T10-59-32-140Z"
      // Actual: "gemini_transactions_both_2025-08-13T10-59-32-140Z.json"
      const actualFilename = `gemini_transactions_${filename.replace('Transactions - ', '')}.json`;
      
      console.log(`[DEBUG] Converting display filename: "${filename}" to actual filename: "${actualFilename}"`);
      
      fetch(`/api/transactions-hub/${actualFilename}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            displayGeminiDataContent(filename, data.data);
            showStatus(`Loaded ${filename}`, 'success', 'fetchStatus');
          } else {
            showStatus(data.error || 'Failed to load file content', 'error', 'fetchStatus');
          }
        })
        .catch(error => {
          console.error(`[DEBUG] Error loading file: ${error.message}`);
          showStatus('Error: ' + error.message, 'error', 'fetchStatus');
        });
    }

    // Load file content (legacy function for backward compatibility)
    function loadFileContent(filename) {
      showStatus(`Loading ${filename}...`, 'info', 'fetchStatus');
      
      // Convert display filename back to actual filename
      const actualFilename = `gemini_transactions_${filename.replace('Transactions - ', '')}.json`;
      
      fetch(`/api/transactions-hub/${actualFilename}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayTransactionData(filename, data.data);
            showStatus(`Loaded ${filename}`, 'success', 'fetchStatus');
          } else {
            showStatus(data.error || 'Failed to load file content', 'error', 'fetchStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'fetchStatus');
        });
    }

    // Display pure data content (raw emails)
    function displayPureDataContent(filename, data) {
      const selectedFileName = document.getElementById('selectedPureDataFileName');
      const pureDataList = document.getElementById('pureDataList');
      const dataDisplay = document.getElementById('pureDataDisplay');
      
      selectedFileName.textContent = filename;
      
      if (data.emails && data.emails.length > 0) {
        pureDataList.innerHTML = `
          <div class="transaction-summary">
            <h4>Raw Email Data</h4>
            <div class="detail-row">
              <span class="detail-label">Total Emails:</span>
              <span class="detail-value">${data.emails.length}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Fetch Date:</span>
              <span class="detail-value">${formatDate(data.fetchDate)}</span>
            </div>
          </div>
          <div class="emails-list">
            ${data.emails.map(email => `
              <div class="email-item" style="background: white; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div class="email-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div class="email-subject" style="font-weight: 600; color: #333;">${email.subject || 'No Subject'}</div>
                  <div class="email-date" style="color: #666; font-size: 0.9em;">${formatDate(email.date)}</div>
                </div>
                <div class="email-from" style="color: #666; margin-bottom: 8px;">From: ${email.from_mail || 'Unknown'}</div>
                <div class="email-snippet" style="color: #333; line-height: 1.5;">${email.snippet || 'No content'}</div>
                
                ${email.queryType ? `<div class="detail-row" style="margin-top: 8px;"><span class="detail-label">Query Type:</span><span class="detail-value">${email.queryType}</span></div>` : ''}
            
            ${email.accountMapping && email.accountMapping.bankAccount ? `
                  <div class="detail-row" style="margin-top: 8px;">
                <span class="detail-label">Mapped Bank Account:</span>
                <span class="detail-value">${email.accountMapping.bankAccount.bankName} - ${email.accountMapping.bankAccount.accountNumber}</span>
              </div>
            ` : ''}
            
            ${email.accountMapping && email.accountMapping.creditCard ? `
                  <div class="detail-row" style="margin-top: 8px;">
                <span class="detail-label">Mapped Credit Card:</span>
                <span class="detail-value">${email.accountMapping.creditCard.provider} - ****${email.accountMapping.creditCard.cardNumber.slice(-4)}</span>
              </div>
            ` : ''}
            
            ${email.transactionDetails ? `
                  <div class="transaction-details" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div class="transaction-type ${email.transactionDetails.type}" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; background: ${email.transactionDetails.type === 'credit' ? '#27ae60' : email.transactionDetails.type === 'debit' ? '#e74c3c' : '#95a5a6'}; margin-bottom: 5px;">
                      ${email.transactionDetails.type ? email.transactionDetails.type.toUpperCase() : 'TRANSACTION'}
                    </div>
                    ${email.transactionDetails.amount ? `<div class="amount" style="font-weight: bold; color: #333;">‚Çπ${email.transactionDetails.amount.toLocaleString()}</div>` : ''}
                    ${email.transactionDetails.merchant ? `<div class="merchant" style="color: #666;">Merchant: ${email.transactionDetails.merchant}</div>` : ''}
                ${email.transactionDetails.keywords && email.transactionDetails.keywords.length > 0 ? `
                      <div class="keywords" style="margin-top: 5px;">
                        ${email.transactionDetails.keywords.map(keyword => `<span class="keyword" style="display: inline-block; background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-right: 5px; margin-bottom: 3px;">${keyword}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${email.statementDetails ? `
                  <div class="statement-details" style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
                    <div class="detail-label" style="font-weight: 600; margin-bottom: 5px;">Statement Details:</div>
                    ${email.statementDetails.statementType ? `<div style="margin-bottom: 3px;">Type: ${email.statementDetails.statementType}</div>` : ''}
                    ${email.statementDetails.period ? `<div style="margin-bottom: 3px;">Period: ${email.statementDetails.period}</div>` : ''}
                ${email.statementDetails.passwordHint ? `
                      <div class="password-hint" style="margin-top: 5px; padding: 5px; background: #fff3cd; border-radius: 3px; font-size: 0.9em;">
                        Password Hint: ${email.statementDetails.passwordHint}
                      </div>
                ` : ''}
                ${email.statementDetails.identifiers && email.statementDetails.identifiers.length > 0 ? `
                      <div style="margin-top: 5px;">Required Identifiers: ${email.statementDetails.identifiers.join(', ')}</div>
                ` : ''}
              </div>
            ` : ''}
            
            ${email.pdfAttachments && email.pdfAttachments.length > 0 ? `
                  <div class="pdf-attachments" style="margin-top: 10px;">
                    <div class="detail-label" style="font-weight: 600; margin-bottom: 5px;">PDF Attachments (${email.pdfAttachments.length}):</div>
                ${email.pdfAttachments.map(pdf => `
                  <div class="pdf-item" style="background: #e8f4fd; border-radius: 8px; padding: 10px; margin: 5px 0;">
                    <div style="font-weight: 500; color: #2c3e50;">${pdf.originalFilename || pdf.filename}</div>
                    <div style="font-size: 0.9em; color: #666;">Size: ${formatFileSize(pdf.size)}</div>
                    ${pdf.storedFilename ? `
                      <div class="button-group" style="margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="viewPDF('${pdf.storedFilename}')" style="font-size: 0.8em; padding: 5px 10px;">
                          View PDF
                        </button>
                        <button class="btn btn-success" onclick="downloadPDF('${pdf.storedFilename}')" style="font-size: 0.8em; padding: 5px 10px;">
                          Download
                        </button>
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
                <div class="email-details" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e1e5e9;">
              <div class="detail-row">
                <span class="detail-label">Email ID:</span>
                <span class="detail-value">${email.email_id}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Processed:</span>
                <span class="detail-value">${formatDate(email.processed_at)}</span>
              </div>
            </div>
          </div>
            `).join('')}
          </div>
        `;
      } else {
        pureDataList.innerHTML = '<div class="no-data">No emails found in this file</div>';
      }
      
      dataDisplay.style.display = 'block';
    }

    // Display Gemini data content
    function displayGeminiDataContent(filename, data) {
      const selectedFileName = document.getElementById('selectedGeminiDataFileName');
      const geminiDataList = document.getElementById('geminiDataList');
      const dataDisplay = document.getElementById('geminiDataDisplay');
      
      selectedFileName.textContent = filename;
      
      if (data.transactions && data.transactions.length > 0) {
        try {
        // Separate transactions and statements
        const transactions = data.transactions.filter(item => item.txn_date || item.credit_debit);
        const statements = data.transactions.filter(item => item.statement_type || item.type === 'statement');
        
        geminiDataList.innerHTML = `
          <div class="transaction-summary">
            <h4>Gemini AI Processed Data</h4>
            <div class="detail-row">
              <span class="detail-label">Total Records:</span>
              <span class="detail-value">${data.transactions.length}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Transactions:</span>
              <span class="detail-value">${transactions.length}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Statements:</span>
              <span class="detail-value">${statements.length}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Emails Processed:</span>
              <span class="detail-value">${data.metadata.total_emails}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Processing Date:</span>
              <span class="detail-value">${formatDate(data.metadata.processed_at)}</span>
            </div>
            ${data.metadata.userProfile ? `
              <div class="detail-row">
                <span class="detail-label">User:</span>
                <span class="detail-value">${data.metadata.userProfile.firstName} ${data.metadata.userProfile.lastName}</span>
              </div>
            ` : ''}
            ${data.metadata.balance && data.metadata.balance.amount ? `
              <div class="detail-row">
                <span class="detail-label">Current Balance:</span>
                <span class="detail-value" style="font-weight: bold; color: #27ae60;">‚Çπ${data.metadata.balance.amount.toLocaleString()}</span>
                <span style="color: #666; font-size: 0.9em;">(${data.metadata.balance.source})</span>
              </div>
            ` : ''}
            ${data.metadata.geminiProcessingSuccess !== undefined ? `
              <div class="detail-row">
                <span class="detail-label">Processing Method:</span>
                <span class="detail-value" style="color: ${data.metadata.geminiProcessingSuccess ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                  ${data.metadata.geminiProcessingSuccess ? 'Gemini AI' : 'Basic Processing (Rate Limited)'}
                </span>
              </div>
            ` : ''}
          </div>
          <div class="transactions-table">
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
              <thead>
                <tr style="background: #667eea; color: white;">
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Type</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Date</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Details</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Party/Description</th>
                  <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Amount</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Source</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">PDF Info</th>
                </tr>
              </thead>
              <tbody>
                ${data.transactions.map(item => {
                  if (item.txn_date || item.credit_debit) {
                    // Transaction row
                    return `
                      <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <span class="transaction-type ${item.credit_debit || 'unknown'}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; background: ${(item.credit_debit || 'unknown') === 'credit' ? '#27ae60' : (item.credit_debit || 'unknown') === 'debit' ? '#e74c3c' : '#95a5a6'};">
                            ${(item.credit_debit || 'UNKNOWN').toUpperCase()}
                          </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${formatDate(item.txn_date)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <div>${item.narration || 'Transaction'}</div>
                          ${item.utr_number ? `<small style="color: #666;">UTR: ${item.utr_number}</small>` : ''}
                          ${item.available_balance ? `<div style="color: #27ae60; font-weight: bold; margin-top: 4px;">Balance: ‚Çπ${item.available_balance.toLocaleString()}</div>` : ''}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${item.rcvd_from_paid_to || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">
                          ${item.txn_amount > 0 ? `‚Çπ${item.txn_amount.toLocaleString()}` : '-'}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <span style="padding: 2px 6px; border-radius: 4px; font-size: 0.7em; background: #ecf0f1; color: #2c3e50;">
                            ${item.source || 'unknown'}
                          </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          ${item.pdf_attached ? 
                            `<span style="color: #27ae60; font-weight: bold;">‚úì PDF</span><br><small style="color: #666;">${item.pdf_password_protected ? 'Protected' : 'Open'}</small><br>${item.pdf_password ? `<span style="font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${item.pdf_password}</span>` : ''}` : 
                            '<span style="color: #95a5a6;">No PDF</span>'
                          }
                        </td>
                      </tr>
                    `;
                  } else if (item.statement_type || item.type === 'statement') {
                    // Statement row
                    return `
                      <tr style="border-bottom: 1px solid #ddd; background: #f8f9fa;">
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; background: #9b59b6;">
                            STATEMENT
                          </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${formatDate(item.statement_date)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <div style="font-weight: bold;">${item.statement_type || 'Statement'}</div>
                          ${item.pdf_filename ? `<small style="color: #666;">File: ${item.pdf_filename}</small>` : ''}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">-</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <span style="padding: 2px 6px; border-radius: 4px; font-size: 0.7em; background: #ecf0f1; color: #2c3e50;">
                            ${item.source || 'gmail-periodic-stmt'}
                          </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          ${item.pdf_attached ? 
                            `<span style="color: #27ae60; font-weight: bold;">‚úì PDF</span><br><small style="color: #666;">${item.pdf_password_protected ? 'Protected' : 'Open'}</small><br>${item.pdf_password ? `<span style="font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${item.pdf_password}</span>` : ''}` : 
                            '<span style="color: #95a5a6;">No PDF</span>'
                          }
                        </td>
                      </tr>
                    `;
                  } else {
                    // Fallback for unknown type
                    return `
                      <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px; border: 1px solid #ddd;">
                          <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; background: #95a5a6;">
                            UNKNOWN
                          </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${formatDate(item.txn_date || item.statement_date || new Date())}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${item.narration || 'Unknown'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">-</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">-</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">-</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">-</td>
                      </tr>
                    `;
                  }
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
              } catch (error) {
          console.error('Error displaying Gemini data:', error);
          geminiDataList.innerHTML = '<div class="no-data">Error displaying data. Please check console for details.</div>';
        }
      } else {
        geminiDataList.innerHTML = '<div class="no-data">No transactions found in this file</div>';
      }
      
      dataDisplay.style.display = 'block';
    }

    // Display transaction data (legacy function for backward compatibility)
    function displayTransactionData(filename, data) {
      const selectedFileName = document.getElementById('selectedFileName');
      const transactionsList = document.getElementById('transactionsList');
      const dataDisplay = document.getElementById('dataDisplay');
      
      selectedFileName.textContent = filename;
      
      if (data.transactions && data.transactions.length > 0) {
        transactionsList.innerHTML = `
          <div class="transaction-summary">
            <h4>Gemini AI Processed Transactions</h4>
            <div class="detail-row">
              <span class="detail-label">Total Transactions:</span>
              <span class="detail-value">${data.transactions.length}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Emails Processed:</span>
              <span class="detail-value">${data.metadata.total_emails}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Processing Date:</span>
              <span class="detail-value">${formatDate(data.metadata.processed_at)}</span>
            </div>
            ${data.metadata.userProfile ? `
              <div class="detail-row">
                <span class="detail-label">User:</span>
                <span class="detail-value">${data.metadata.userProfile.firstName} ${data.metadata.userProfile.lastName}</span>
              </div>
            ` : ''}
            ${data.metadata.balance && data.metadata.balance.amount ? `
              <div class="detail-row">
                <span class="detail-label">Current Balance:</span>
                <span class="detail-value" style="font-weight: bold; color: #27ae60;">‚Çπ${data.metadata.balance.amount.toLocaleString()}</span>
                <span style="color: #666; font-size: 0.9em;">(${data.metadata.balance.source})</span>
              </div>
            ` : ''}
          </div>
          <div class="transactions-table">
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
              <thead>
                <tr style="background: #667eea; color: white;">
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Date</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">UTR/Reference</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Type</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Party Name</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Narration</th>
                  <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Amount</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Source</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">PDF Info</th>
                </tr>
              </thead>
              <tbody>
                ${data.transactions.map(txn => `
                  <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 12px; border: 1px solid #ddd;">${formatDate(txn.txn_date)}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${txn.utr_number || '-'}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                      <span class="transaction-type ${txn.credit_debit}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; background: ${txn.credit_debit === 'credit' ? '#27ae60' : txn.credit_debit === 'debit' ? '#e74c3c' : '#95a5a6'};">
                        ${txn.credit_debit.toUpperCase()}
                      </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${txn.rcvd_from_paid_to}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${txn.narration}</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">
                      ${txn.txn_amount > 0 ? `‚Çπ${txn.txn_amount.toLocaleString()}` : '-'}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                      <span style="padding: 2px 6px; border-radius: 4px; font-size: 0.7em; background: #ecf0f1; color: #2c3e50;">
                        ${txn.source}
                      </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                      ${txn.pdf_attached ? 
                        `<span style="color: #27ae60; font-weight: bold;">‚úì PDF</span><br><small style="color: #666;">${txn.pdf_password_protected ? 'Protected' : 'Open'}</small><br>${txn.pdf_password ? `<span style="font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${txn.pdf_password}</span>` : ''}` : 
                        '<span style="color: #95a5a6;">No PDF</span>'
                      }
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        transactionsList.innerHTML = '<div class="no-data">No transactions found in this file</div>';
      }
      
      dataDisplay.style.display = 'block';
    }

    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return 'Unknown';
      try {
        return new Date(dateString).toLocaleString();
      } catch {
        return dateString;
      }
    }

    // Test API function
    function testAPI() {
      showStatus('Testing API connection...', 'info');
      
      fetch('/api/hello')
        .then(response => response.json())
        .then(data => {
          showStatus('API Test: ' + data.message, 'success');
        })
        .catch(error => {
          showStatus('API Test failed: ' + error.message, 'error');
        });
    }

    // Load saved profiles
    function loadSavedProfiles() {
      const btn = document.getElementById('loadProfilesBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = 'Loading profiles...';
      spinner.style.display = 'inline-block';
      
      showStatus('Loading saved profiles...', 'info', 'profilesStatus');
      
      fetch('/api/user-profiles')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayProfilesList(data.profiles);
            showStatus(`Loaded ${data.profiles.length} saved profiles`, 'success', 'profilesStatus');
          } else {
            showStatus(data.error || 'Failed to load profiles', 'error', 'profilesStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'profilesStatus');
        })
        .finally(() => {
          // Hide spinner and re-enable button
          btn.disabled = false;
          btnText.textContent = 'Load Saved Profiles';
          spinner.style.display = 'none';
        });
    }

    // Display profiles list
    function displayProfilesList(profiles) {
      const profilesListDiv = document.getElementById('profilesList');
      
      if (profiles.length === 0) {
        profilesListDiv.innerHTML = '<div class="no-data">No saved profiles found. Create a profile first!</div>';
      } else {
        profilesListDiv.innerHTML = profiles.map(profile => `
          <div class="file-card" onclick="selectProfile('${profile.userId}')">
            <div class="file-name">${profile.firstName} ${profile.lastName}</div>
            <div class="file-info">
              <div>Email: ${profile.email}</div>
              <div>Bank Accounts: ${profile.bankAccountsCount}</div>
              <div>Credit Cards: ${profile.creditCardsCount}</div>
              <div>Created: ${new Date(profile.created).toLocaleString()}</div>
              <div>Modified: ${new Date(profile.modified).toLocaleString()}</div>
            </div>
            <div class="file-size">ID: ${profile.userId}</div>
          </div>
        `).join('');
      }
      
      profilesListDiv.style.display = 'block';
    }

    // Select profile
    function selectProfile(userId) {
      selectedProfileId = userId;
      showStatus(`Loading profile details...`, 'info', 'profilesStatus');
      
      fetch(`/api/user-profile/${userId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayProfileDetails(data.profile);
            showStatus(`Profile loaded successfully`, 'success', 'profilesStatus');
          } else {
            showStatus(data.error || 'Failed to load profile', 'error', 'profilesStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'profilesStatus');
        });
    }

    // Display profile details
    function displayProfileDetails(profile) {
      const selectedProfileName = document.getElementById('selectedProfileName');
      const profileInfo = document.getElementById('profileInfo');
      const profileDetails = document.getElementById('profileDetails');
      
      selectedProfileName.textContent = `${profile.firstName} ${profile.lastName}`;
      
      profileInfo.innerHTML = `
        <div class="email-details">
          <div class="detail-row">
            <span class="detail-label">Email:</span>
            <span class="detail-value">${profile.email}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">User ID:</span>
            <span class="detail-value">${profile.userId}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Bank Accounts:</span>
            <span class="detail-value">${profile.bankAccounts ? profile.bankAccounts.length : 0}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Credit Cards:</span>
            <span class="detail-value">${profile.creditCards ? profile.creditCards.length : 0}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Created:</span>
            <span class="detail-value">${formatDate(profile.createdAt)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Updated:</span>
            <span class="detail-value">${formatDate(profile.updatedAt)}</span>
          </div>
        </div>
        
        ${profile.bankAccounts && profile.bankAccounts.length > 0 ? `
          <div class="transaction-details">
            <h4>Bank Accounts:</h4>
            ${profile.bankAccounts.map(account => `
              <div class="detail-row">
                <span class="detail-label">${account.bankName}:</span>
                <span class="detail-value">${account.accountNumber} (${account.accountType})</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        ${profile.creditCards && profile.creditCards.length > 0 ? `
          <div class="statement-details">
            <h4>Credit Cards:</h4>
            ${profile.creditCards.map(card => `
              <div class="detail-row">
                <span class="detail-label">${card.provider}:</span>
                <span class="detail-value">****${card.cardNumber.slice(-4)} (${card.cardType})</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
      
      profileDetails.style.display = 'block';
    }

    // Continue with selected profile
    function continueWithProfile() {
      if (!selectedProfileId) {
        showStatus('Please select a profile first', 'error', 'profilesStatus');
        return;
      }
      
      currentUserId = selectedProfileId;
      currentProfile = selectedProfileId;
      
      showStatus('Profile activated! You can now fetch transactions.', 'success', 'profilesStatus');
      
      // Switch to fetch tab
      showTab('fetch');
      // Hide prerequisites message
      document.getElementById('fetchPrerequisites').style.display = 'none';
    }

    // Edit profile
    function editProfile() {
      if (!selectedProfileId) {
        showStatus('Please select a profile first', 'error', 'profilesStatus');
        return;
      }
      
      // Load profile data into setup form
      fetch(`/api/user-profile/${selectedProfileId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadProfileIntoForm(data.profile);
            showTab('setup');
            showStatus('Profile loaded for editing', 'success', 'profilesStatus');
          } else {
            showStatus(data.error || 'Failed to load profile for editing', 'error', 'profilesStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'profilesStatus');
        });
    }

    // Load profile into form
    function loadProfileIntoForm(profile) {
      // Set basic info
      document.getElementById('firstName').value = profile.firstName || '';
      document.getElementById('lastName').value = profile.lastName || '';
      document.getElementById('email').value = profile.email || '';
      document.getElementById('panNumber').value = profile.identifiers?.panNumber || '';
      document.getElementById('dateOfBirth').value = profile.identifiers?.dateOfBirth || '';
      document.getElementById('phoneNumber').value = profile.identifiers?.phoneNumber || '';
      
      // Clear existing accounts
      document.getElementById('bankAccountsList').innerHTML = '';
      document.getElementById('creditCardsList').innerHTML = '';
      bankAccounts = [];
      creditCards = [];
      
      // Load bank accounts
      if (profile.bankAccounts && profile.bankAccounts.length > 0) {
        profile.bankAccounts.forEach(account => {
          addBankAccount();
          const accountId = bankAccounts[bankAccounts.length - 1].id;
          updateBankAccount(accountId, 'bankName', account.bankName);
          updateBankAccount(accountId, 'accountNumber', account.accountNumber);
          updateBankAccount(accountId, 'accountType', account.accountType);
        });
      } else {
        addBankAccount(); // Add one empty account
      }
      
      // Load credit cards
      if (profile.creditCards && profile.creditCards.length > 0) {
        profile.creditCards.forEach(card => {
          addCreditCard();
          const cardId = creditCards[creditCards.length - 1].id;
          updateCreditCard(cardId, 'provider', card.provider);
          updateCreditCard(cardId, 'cardNumber', card.cardNumber);
          updateCreditCard(cardId, 'cardType', card.cardType);
        });
      } else {
        addCreditCard(); // Add one empty card
      }
      
      // Set current user ID for updating
      currentUserId = profile.userId;
    }

    // Delete profile
    function deleteProfile() {
      if (!selectedProfileId) {
        showStatus('Please select a profile first', 'error', 'profilesStatus');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
        return;
      }
      
      showStatus('Deleting profile...', 'info', 'profilesStatus');
      
      fetch(`/api/user-profile/${selectedProfileId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus('Profile deleted successfully', 'success', 'profilesStatus');
          selectedProfileId = null;
          document.getElementById('profileDetails').style.display = 'none';
          loadSavedProfiles(); // Reload the list
        } else {
          showStatus(data.error || 'Failed to delete profile', 'error', 'profilesStatus');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error', 'profilesStatus');
      });
    }

    // Toggle fetch method function
    function toggleFetchMethod() {
      const fetchMethod = document.querySelector('input[name="fetchMethod"]:checked').value;
      const maxEmailsGroup = document.getElementById('maxEmailsGroup');
      const dateRangeGroup = document.getElementById('dateRangeGroup');
      const toDateGroup = document.getElementById('toDateGroup');
      
      if (fetchMethod === 'count') {
        maxEmailsGroup.style.display = 'block';
        dateRangeGroup.style.display = 'none';
        toDateGroup.style.display = 'none';
      } else {
        maxEmailsGroup.style.display = 'none';
        dateRangeGroup.style.display = 'block';
        toDateGroup.style.display = 'block';
      }
    }

    // Check if user is authenticated
    function isUserAuthenticated() {
      // Check if we have a currentUserId and if the user has gone through Google auth
      return currentUserId !== null;
    }

    // Fetch and process data function
    function fetchAndProcessData() {
      if (!currentUserId) {
        showStatus('Please set up your profile first. Go to Profile Setup tab and save your profile.', 'error', 'fetchStatus');
        return;
      }

      const emailType = document.getElementById('emailType').value;
      const fetchMethod = document.querySelector('input[name="fetchMethod"]:checked').value;
      
      let maxEmails = null;
      let fromDate = null;
      let toDate = null;
      
      if (fetchMethod === 'count') {
        maxEmails = parseInt(document.getElementById('maxEmails').value) || 20;
      } else {
        fromDate = document.getElementById('fromDate').value;
        toDate = document.getElementById('toDate').value;
        
        if (!fromDate || !toDate) {
          showStatus('Please select both from and to dates', 'error', 'fetchStatus');
          return;
        }
      }
      
      const btn = document.getElementById('fetchAndProcessBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      const methodText = fetchMethod === 'count' ? `${maxEmails} emails` : `emails from ${fromDate} to ${toDate}`;
      btnText.textContent = `Fetching & processing ${emailType} ${methodText}...`;
      spinner.style.display = 'inline-block';
      
                showStatus(`Fetching ${emailType} ${methodText} and processing with Gemini AI... (Batched processing for efficiency)`, 'info', 'fetchStatus');

      fetch('/api/fetch-emails-enhanced', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: currentUserId,
          maxEmails: maxEmails,
          fromDate: fromDate,
          toDate: toDate,
          emailType: emailType
        })
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Please authenticate with Google first. Click "Subscribe with Google" to login.');
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          let statusMessage = `Successfully fetched ${data.data.emails.length} emails and saved to ${data.filename}`;
          if (data.geminiData) {
            const processingMethod = data.geminiData.metadata.geminiProcessingSuccess ? 'Gemini AI' : 'Basic Processing (Gemini rate limited)';
            statusMessage += `, processed ${data.geminiData.metadata.total_transactions} transactions with ${processingMethod}`;
          }
          showStatus(statusMessage, 'success', 'fetchStatus');
          // Switch to view tab
          showTab('view');
          setTimeout(() => loadTransactions(), 1000);
        } else {
          showStatus(data.error || 'Failed to fetch and process emails', 'error', 'fetchStatus');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error', 'fetchStatus');
      })
      .finally(() => {
        // Hide spinner and re-enable button
        btn.disabled = false;
        btnText.textContent = 'Fetch & Process with Gemini AI';
        spinner.style.display = 'none';
      });
    }

    // Delete all data function
    function deleteAllData() {
      if (!confirm('Are you sure you want to delete ALL data? This will permanently remove:\n\n‚Ä¢ All PDF attachments\n‚Ä¢ All email data files\n‚Ä¢ All transaction files\n\nThis action cannot be undone!')) {
        return;
      }

      const btn = document.querySelector('button[onclick="deleteAllData()"]');
      const btnText = btn.querySelector('.btn-text');
      
      // Show loading state
      btn.disabled = true;
      btnText.textContent = 'üóëÔ∏è Deleting...';
      
      showStatus('Deleting all stored data...', 'info', 'fetchStatus');

      fetch('/api/delete-all-data', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus(`Successfully deleted ${data.deletedCount} files`, 'success', 'fetchStatus');
          // Refresh the view tab if it's open
          if (document.getElementById('viewTab').style.display !== 'none') {
            setTimeout(() => {
              loadPureData();
              loadGeminiData();
            }, 1000);
          }
        } else {
          showStatus(data.error || 'Failed to delete data', 'error', 'fetchStatus');
        }
      })
      .catch(error => {
        showStatus('Error: ' + error.message, 'error', 'fetchStatus');
      })
      .finally(() => {
        // Reset button state
        btn.disabled = false;
        btnText.textContent = 'üóëÔ∏è Delete All Data';
      });
    }

    // Load PDF attachments function
    function loadPDFAttachments() {
      const btn = document.getElementById('loadPDFsBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner');
      
      // Show spinner and disable button
      btn.disabled = true;
      btnText.textContent = 'Loading PDF attachments...';
      spinner.style.display = 'inline-block';
      
      showStatus('Loading PDF attachments...', 'info', 'pdfsStatus');
      
      fetch('/api/pdf-attachments')
        .then(response => {
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('Please authenticate with Google first. Click "Subscribe with Google" to login.');
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            displayPDFsList(data.files);
            showStatus(`Loaded ${data.files.length} PDF attachments`, 'success', 'pdfsStatus');
          } else {
            showStatus(data.error || 'Failed to load PDF attachments', 'error', 'pdfsStatus');
          }
        })
        .catch(error => {
          showStatus('Error: ' + error.message, 'error', 'pdfsStatus');
        })
        .finally(() => {
          // Hide spinner and re-enable button
          btn.disabled = false;
          btnText.textContent = 'Load PDF Attachments';
          spinner.style.display = 'none';
        });
    }

    // Display PDFs list
    function displayPDFsList(files) {
      const pdfsListDiv = document.getElementById('pdfsList');
      const pdfsSection = document.getElementById('pdfsSection');
      
      if (files.length === 0) {
        pdfsListDiv.innerHTML = '<div class="no-data">No PDF attachments found. Fetch some emails with PDF attachments first!</div>';
      } else {
        pdfsListDiv.innerHTML = files.map(file => {
          const passwordDisplay = file.isProtected ? 
            `<div class="password-info" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
              <strong>üîí Password Protected:</strong> ${file.password || 'Password not available'}
            </div>` : 
            `<div class="password-info" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
              <strong>üîì No Password Required</strong>
            </div>`;
          
          return `
            <div class="file-card">
              <div class="file-name">${file.filename}</div>
              <div class="file-info">
                <div>Created: ${new Date(file.created).toLocaleString()}</div>
                <div>Modified: ${new Date(file.modified).toLocaleString()}</div>
              </div>
              <div class="file-size">${formatFileSize(file.size)}</div>
              ${passwordDisplay}
              <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="viewPDF('${file.filename}')" style="font-size: 0.9em; padding: 8px 15px;">
                  View PDF
                </button>
                <button class="btn btn-success" onclick="downloadPDF('${file.filename}')" style="font-size: 0.9em; padding: 8px 15px;">
                  Download
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      pdfsSection.style.display = 'block';
    }

    // View PDF function
    function viewPDF(filename) {
      const url = `/api/pdf-attachments/${filename}`;
      window.open(url, '_blank');
    }

    // Download PDF function
    function downloadPDF(filename) {
      const url = `/api/pdf-attachments/${filename}`;
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Debug PDF detection function
    function debugPDFDetection(emailId) {
      console.log(`Debugging PDF detection for email: ${emailId}`);
      
      fetch('/api/debug-pdf-detection', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          emailId: emailId
        })
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Please authenticate with Google first. Click "Subscribe with Google" to login.');
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log('PDF Detection Debug Results:', data);
          alert(`PDF Detection Debug Results:\n\nEmail: ${data.subject}\nFrom: ${data.from}\nPDF Attachments Found: ${data.pdfAttachments.length}\n\nPayload Structure:\n- MIME Type: ${data.payloadStructure.mimeType}\n- Has Parts: ${data.payloadStructure.hasParts}\n- Parts Count: ${data.payloadStructure.partsCount}\n\nCheck browser console for detailed logs.`);
        } else {
          alert('Debug failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Debug error:', error);
        alert('Debug error: ' + error.message);
      });
    }



    // Load stored form data on page load
    window.addEventListener('load', function() {
      // Add initial bank account and credit card fields
      addBankAccount();
      addCreditCard();
    });
  </script>
</body>
</html> 